<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/camp-detail.css}">
  <link rel="stylesheet" th:href="@{/css/review-all.css}">
  <link rel="stylesheet" th:href="@{/css/weather-widget.css}">

  <title th:text="${camp?.facltNm} ? ${camp.facltNm + ' | ìƒì„¸ ì •ë³´'} : 'ìº í•‘ì¥ ìƒì„¸ ì •ë³´'">ìº í•‘ì¥ ìƒì„¸ ì •ë³´</title>
</head>
<body>
<div th:replace="~{fragments/topmenu :: beforeLoginTop}"></div>

<div th:replace="~{fragments/topmenu :: afterLoginTop}"></div>

<div th:replace="~{fragments/topmenu :: header}"></div>
<th:block th:replace="~{fragments/toolbar :: scrollingToolbar}"></th:block>

<div class="camp-detail-container" th:if="${camp}">

  <section class="detail-header">
    <div style="display: flex; align-items: center; justify-content: center;">
      <h1 th:text="${camp.facltNm}">í•˜ëŠ˜ ì •ì› ìº í•‘ì¥</h1>
      <button class="scrap-btn"
              th:data-content-id="${camp.contentId}"
              th:data-scrapped="${camp.scrapped}"
              th:text="${camp.scrapped} ? 'â˜…' : 'â˜†'"
              style="margin-left: 10px; font-size: 2rem; background: none; border: none; cursor: pointer;">
      </button>
    </div>
    <p th:text="${camp.lctCl} + ' | ' + ${camp.induty}">ì‚°/ìˆ² | ì¼ë°˜ì•¼ì˜ì¥</p>
  </section>

  <section class="detail-main-info">
    <div class="main-image-wrapper">
      <img th:src="${camp.firstImageUrl != null and !camp.firstImageUrl.isEmpty()
        ? camp.firstImageUrl
        : (campImages != null and #lists.size(campImages) > 0 ? campImages[0] : '/images/ì„ì‹œì‚¬ì§„.png')}"
           alt="ìº í•‘ì¥ ëŒ€í‘œ ì´ë¯¸ì§€">
    </div>

    <div class="core-info-wrapper">
      <h2>ìº í•‘ì¥ ì†Œê°œ</h2>
      <p class="intro-text" th:text="${camp.intro}">ìº í•‘ì¥ ì†Œê°œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
      <p class="feature-text" th:text="${camp.featureNm}">íŠ¹ì§•ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>

      <ul class="info-list">
        <li><strong>ì£¼ì†Œ</strong><span id="camp-address" th:text="${camp.addr1}">ì£¼ì†Œ ì •ë³´</span></li>
        <li><strong>ì—°ë½ì²˜</strong><span th:text="${camp.tel}">ì—°ë½ì²˜ ì •ë³´</span></li>
        <li><strong>ìš´ì˜ ê¸°ê°„</strong><span th:text="${camp.operPdCl}">ìš´ì˜ ê¸°ê°„ ì •ë³´</span></li>
        <li>
          <strong>í™ˆí˜ì´ì§€</strong>
          <a th:if="${camp.homepage != null and !camp.homepage.isEmpty()}"
             th:href="${#strings.startsWith(#strings.trim(camp.homepage), 'http') ? #strings.trim(camp.homepage) : '//' + #strings.trim(camp.homepage)}"
             target="_blank">ë°”ë¡œê°€ê¸°</a>
          <span th:unless="${camp.homepage != null and !camp.homepage.isEmpty()}">ì •ë³´ ì—†ìŒ</span>
        </li>
        <li>
          <strong>ì˜ˆì•½</strong>
          <a th:if="${camp.resveUrl != null and !camp.resveUrl.isEmpty()}" th:href="${camp.resveUrl}" target="_blank">ì˜ˆì•½ í˜ì´ì§€ë¡œ ì´ë™</a>
          <span th:unless="${camp.resveUrl != null and !camp.resveUrl.isEmpty()}">ì •ë³´ ì—†ìŒ</span>
        </li>
      </ul>
    </div>
  </section>

  <section class="detail-extra-info">
    <div class="info-box">
      <h3>ì£¼ìš” ì‹œì„¤</h3>
      <p th:if="${camp.gnrlSiteCo != null}" th:text="'ì¼ë°˜ì•¼ì˜(' + ${camp.gnrlSiteCo} + ') | ìë™ì°¨ì•¼ì˜(' + ${camp.autoSiteCo} + ') | ê¸€ë¨í•‘(' + ${camp.glampSiteCo} + ') | ì¹´ë¼ë°˜(' + ${camp.caravSiteCo} + ')'"></p>
    </div>
    <div class="info-box">
      <h3>ë¶€ëŒ€ ì‹œì„¤</h3>
      <p th:text="${camp.sbrsCl}">ë¶€ëŒ€ì‹œì„¤ ì •ë³´</p>
    </div>
    <div class="info-box">
      <h3>í…Œë§ˆ í™˜ê²½</h3>
      <p th:text="${camp.themaEnvrnCl}">í…Œë§ˆ í™˜ê²½ ì •ë³´</p>
    </div>
  </section>

  <section class="detail-slider">
    <div class="gallery-header-row">
      <h2>
        ê°¤ëŸ¬ë¦¬
        <span class="image-count" th:if="${(camp.firstImageUrl != null and !camp.firstImageUrl.isEmpty()) or (campImages != null and !#lists.isEmpty(campImages))}">
        (<span th:text="${(camp.firstImageUrl != null and !camp.firstImageUrl.isEmpty() ? 1 : 0) + #lists.size(campImages)}"></span>ì¥)
        </span>

        <div class="slide-item" th:if="${#strings.isEmpty(camp.firstImageUrl) and (#lists.isEmpty(campImages) or campImages == null)}">
      </h2>
      <a th:href="@{/camping/gallery(campingId=${camp.contentId})}" class="all-review-btn gallery-all-review-btn">ê°¤ëŸ¬ë¦¬ ì „ì²´ë³´ê¸°</a>
    </div>

    <div class="slider-wrapper" th:if="${(camp.firstImageUrl != null and !camp.firstImageUrl.isEmpty()) or (campImages != null and #arrays.length(campImages) > 0)}">
      <div class="slide-item" th:each="imageUrl : ${campImages}" th:if="${imageUrl != null and !imageUrl.isEmpty()}">
        <img th:src="${imageUrl}" th:alt="'ìº í•‘ì¥ ì´ë¯¸ì§€ ' + ${#arrays.length(campImages)}">
      </div>
    </div>

    <div class="slide-item" th:if="${#strings.isEmpty(camp.firstImageUrl) and (#arrays.isEmpty(campImages) or campImages == null)}">
      <p>ğŸ“· ì´ë¯¸ì§€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
      <p>ìº í•‘ì¥ì˜ ì•„ë¦„ë‹¤ìš´ ëª¨ìŠµì„ ê³§ ë§Œë‚˜ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
  </section>

  <section class="detail-reviews">
    <div class="reviews-header">
      <h2>ë°©ë¬¸ì ë¦¬ë·° <span th:if="${!#lists.isEmpty(reviews)}">(<span th:text="${#lists.size(reviews)}"></span>ê°œ)</span></h2>
      <div class="reviews-header">
        <a th:href="@{/reviews/all(campingId=${camp.contentId})}" class="all-review-btn">ë¦¬ë·° ì „ì²´ë³´ê¸°</a>
        <a th:href="@{/reviews/write(campingId=${camp.contentId})}" class="write-review-btn">ë¦¬ë·° ì‘ì„±</a>
      </div>
    </div>

    <div class="review-summary" id="review-summary">

      <div class="avg-score">
        <span class="score" th:text="${#numbers.formatDecimal(reviewStats.avg, 1, 1)}">5.0</span>
        <span class="slash">/ 5</span>
      </div>

      <div class="score-bars">
        <div class="score-bar" th:each="i : ${#numbers.sequence(4,0)}">
          <span class="star-label">â˜… <span th:text="${i + 1}">5</span></span>
          <div class="bar-bg">
            <div class="bar-fill" th:style="|width:${scorePercent[i] ?: 0}%|"></div>
          </div>
        </div>
      </div>

    </div>

    <div class="all-keywords">

      <div class="review-keywords" th:if="${naverKeywords != null and not #lists.isEmpty(naverKeywords)}">
        <h4>ì—°ê´€ í‚¤ì›Œë“œ</h4>
        <div class="tag-cloud">
            <span class="tag" th:each="keyword : ${naverKeywords}" th:text="'#' + ${keyword}">
              #ê¹¨ë—í•´ìš”
            </span>
        </div>
      </div>

    </div>

    <div class="slider-wrapper" th:if="${!#lists.isEmpty(reviews)}">
      <div class="review-card" th:each="review, iterStat : ${reviews}" th:if="${iterStat.index < 3}">
        <div class="review-header">
          <span class="review-stars">
            <th:block th:each="i : ${#numbers.sequence(1, 5)}">
              <span th:if="${i <= review.score}">â˜…</span><span th:unless="${i <= review.score}">â˜†</span>
            </th:block>
          </span>
          <span class="review-writer" th:text="${review.writer}">ì‘ì„±ì</span>
        </div>
        <p class="review-content" th:text="${review.content}">
          ë¦¬ë·° ë‚´ìš©ì´ ì—¬ê¸°ì— ë‘ ì¤„ê¹Œì§€ í‘œì‹œë©ë‹ˆë‹¤. ë‚´ìš©ì´ ê¸¸ë©´ ë§ì¤„ì„í‘œë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        </p>
      </div>
    </div>

    <div class="no-reviews-message" th:if="${#lists.isEmpty(reviews)}">
      <p>ğŸ“ ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ì–´ìš”.</p>
      <p>ì´ ìº í•‘ì¥ì˜ ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>
    </div>
  </section>

  <div id="reviewModal" class="review-modal">
    <div class="review-modal-content">
      <div class="review-modal-header">
        <h3>ë¦¬ë·° ì‘ì„±</h3>
        <span class="close-modal" onclick="closeReviewModal()">&times;</span>
      </div>
      <form id="reviewForm" class="review-form">
        <input type="hidden" id="campingId" th:value="${camp.contentId}">
        <input type="hidden" id="reviewId" value="">

        <div class="rating-section">
          <label>í‰ì </label>
          <div class="star-rating">
            <input type="radio" id="star5" name="rating" value="5">
            <label for="star5">â˜…</label>
            <input type="radio" id="star4" name="rating" value="4">
            <label for="star4">â˜…</label>
            <input type="radio" id="star3" name="rating" value="3">
            <label for="star3">â˜…</label>
            <input type="radio" id="star2" name="rating" value="2">
            <label for="star2">â˜…</label>
            <input type="radio" id="star1" name="rating" value="1">
            <label for="star1">â˜…</label>
          </div>
        </div>

        <div class="content-section">
          <label for="reviewContent">ë¦¬ë·° ë‚´ìš©</label>
          <textarea id="reviewContent" name="content" placeholder="ìº í•‘ì¥ì— ëŒ€í•œ ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”..." required></textarea>
        </div>

        <div class="form-buttons">
          <button type="button" class="cancel-btn" onclick="closeReviewModal()">ì·¨ì†Œ</button>
          <button type="submit" class="submit-btn">ë“±ë¡</button>
        </div>
      </form>
    </div>
  </div>

  <section class="detail-map">
    <h2>ìº í•‘ì¥ ìœ„ì¹˜</h2>
    <div id="map-placeholder">ì§€ë„ê°€ í‘œì‹œë  ì˜ì—­ì…ë‹ˆë‹¤.</div>
  </section>

  <!-- ë‚ ì”¨ ì •ë³´ ì„¹ì…˜ ì¶”ê°€ -->
  <section class="detail-weather" th:if="${camp.mapY != null and camp.mapX != null}">
    <h2>ìº í•‘ì¥ ì£¼ë³€ ë‚ ì”¨</h2>
    <div id="weather-widget-container"></div>
  </section>

</div>

<div class="camp-detail-container" th:unless="${camp}">
  <h1>ìº í•‘ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h1>
  <p>ìš”ì²­í•˜ì‹  ìº í•‘ì¥ì„ ì°¾ì§€ ëª»í–ˆê±°ë‚˜, ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
  <a th:href="@{/}">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ad22c50321e4a335c662c04e1bada00b&libraries=services"></script>
<script th:inline="javascript">
  var campName = '[[${camp.facltNm}]]';
  var address = '[[${camp.addr1}]]';
  var campTel = '[[${camp.tel}]]';
  var mapY = /*[[${camp.mapY}]]*/ null;
  var mapX = /*[[${camp.mapX}]]*/ null;
</script>
<script src="/js/camp-map.js"></script>

<!-- ë°”ë‹ë¼ ë‚ ì”¨ ìœ„ì ¯ -->
<script th:src="@{/js/weather-widget.js}"></script>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', () => {
    const weatherContainer = document.getElementById('weather-widget-container');

    if (weatherContainer && mapY && mapX) {
      const nearestCity = (function findNearestCity(lat, lng) {
        const cities = {
          'ì„œìš¸': { lat: 37.5665, lng: 126.9780 }, 'ë¶€ì‚°': { lat: 35.1796, lng: 129.0756 },
          'ëŒ€êµ¬': { lat: 35.8714, lng: 128.6014 }, 'ì¸ì²œ': { lat: 37.4563, lng: 126.7052 },
          'ê´‘ì£¼': { lat: 35.1595, lng: 126.8526 }, 'ëŒ€ì „': { lat: 36.3504, lng: 127.3845 },
          'ìš¸ì‚°': { lat: 35.5384, lng: 129.3114 }, 'ì„¸ì¢…': { lat: 36.4800, lng: 127.2890 },
          'ê²½ê¸°': { lat: 37.4138, lng: 127.5183 }, 'ê°•ì›': { lat: 37.8228, lng: 128.1555 },
          'ì¶©ë¶': { lat: 36.8000, lng: 127.7000 }, 'ì¶©ë‚¨': { lat: 36.5184, lng: 126.8000 },
          'ì „ë¶': { lat: 35.7175, lng: 127.1530 }, 'ì „ë‚¨': { lat: 34.8679, lng: 126.9910 },
          'ê²½ë¶': { lat: 36.4919, lng: 128.8889 }, 'ê²½ë‚¨': { lat: 35.4606, lng: 128.2132 },
          'ì œì£¼': { lat: 33.4996, lng: 126.5312 }
        };
        const R = 6371;
        const d2r = Math.PI/180;
        let best = 'ì„œìš¸', min = Infinity;
        for (const [city, c] of Object.entries(cities)) {
          const dLat = (c.lat - lat) * d2r, dLng = (c.lng - lng) * d2r;
          const a = Math.sin(dLat/2)**2 + Math.cos(lat*d2r)*Math.cos(c.lat*d2r)*Math.sin(dLng/2)**2;
          const d = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * R;
          if (d < min) { min = d; best = city; }
        }
        return best;
      })(parseFloat(mapY), parseFloat(mapX));

      // ì „ì—­ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ ìœ ì§€
      window.campingLocation = nearestCity;

      // ë°”ë‹ë¼ ìœ„ì ¯ ë§ˆìš´íŠ¸
      initWeatherWidget(weatherContainer, nearestCity);
    }
  });
  document.addEventListener('DOMContentLoaded', function() {
    const scrapBtn = document.querySelector('.scrap-btn');

    if (scrapBtn) {
        scrapBtn.addEventListener('click', function() {
            // Thymeleafë¥¼ í†µí•´ HTMLì— ë¯¸ë¦¬ ì €ì¥í•´ë‘” ìº í•‘ì¥ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const campData = {
                contentId: /*[[${camp.contentId}]]*/ null,
                facltNm: /*[[${camp.facltNm}]]*/ null,
                firstImageUrl: /*[[${camp.firstImageUrl}]]*/ null,
                addr1: /*[[${camp.addr1}]]*/ null
            };

            // ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆë©´ ì‹¤í–‰ì„ ì¤‘ë‹¨í•˜ê³  ì•Œë¦¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
            // Spring Securityì˜ principal ê°ì²´ë¥¼ í™•ì¸í•˜ì—¬ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.
            const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
            if (!isAuthenticated) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
                window.location.href = '/login'; // ë¡œê·¸ì¸ í˜ì´ì§€ ê²½ë¡œë¡œ ì´ë™
                return;
            }

            // ì»¨íŠ¸ë¡¤ëŸ¬ì˜ /api/scraps/toggle ì£¼ì†Œë¡œ POST ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
            fetch('/api/scraps/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Spring Security CSRF í† í°ì´ í™œì„±í™”ëœ ê²½ìš° í—¤ë”ì— ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
                    // 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                },
                body: JSON.stringify(campData) // ìº í•‘ì¥ ì •ë³´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
            })
            .then(response => {
                if (response.status === 401) { // Unauthorized
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    throw new Error('Unauthorized');
                }
                if (!response.ok) {
                    throw new Error('ìŠ¤í¬ë© ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(data => {
                // ì»¨íŠ¸ë¡¤ëŸ¬ë¡œë¶€í„° ë°›ì€ ì‘ë‹µ(isScrapped)ì— ë”°ë¼ ë²„íŠ¼ì˜ ìƒíƒœë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
                const isScrapped = data.isScrapped;
                this.textContent = isScrapped ? 'â˜…' : 'â˜†';
                this.dataset.scrapped = isScrapped;
                if (isScrapped) {
                    alert('ìº í•‘ì¥ì„ ìŠ¤í¬ë©í–ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ìº í•‘ì¥ ìŠ¤í¬ë©ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                // ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ì½˜ì†”ì— ì¶œë ¥í•˜ê³  ì‚¬ìš©ìì—ê²Œ ì•Œë¦½ë‹ˆë‹¤.
                if (error.message !== 'Unauthorized') {
                    console.error('Error:', error);
                    alert(error.message);
                }
            });
        });
    }
  });
</script>

</body>
</html>