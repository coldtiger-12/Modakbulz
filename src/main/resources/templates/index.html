<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ë‹¥ë¶ˆì¦ˆ</title>
  <link rel="stylesheet" href="" th:href="@{/css/common.css}">
  <link rel="stylesheet" href="" th:href="@{/css/weather-widget.css}">
  <link rel="stylesheet" href="" th:href="@{/css/footer.css}">
</head>

<body>
  <!-- íƒ‘ ë©”ë‰´ -->
  <div th:replace="~{fragments/topmenu :: beforeLoginTop}"></div>
  <div th:replace="~{fragments/topmenu :: afterLoginTop}"></div>

  <!-- í—¤ë” ì˜ì—­ -->
  <div th:replace="~{fragments/topmenu :: header}"></div>
  <th:block th:replace="~{fragments/toolbar :: scrollingToolbar}"></th:block>


  <!-- ë©”ì¸ í˜ì´ì§€ -->
  <div class="main-container" style="opacity: 0; transition: opacity 0.5s ease;">

    <!-- ìƒë‹¨ -->
    <div class="top-area">

      <!-- ê²€ìƒ‰ -->
      <section class="search-area">
        <h2>ìº í•‘ì¥ & ê¸€ë¨í•‘ì¥ ê²€ìƒ‰</h2>
        <form th:action="@{/camping/search}" method="get" id="searchForm" class="search-form">
          <div class="search-box">
            <div class="form-fields">
              <div class="form-row keyword-container">
                <label>í‚¤ì›Œë“œ</label>
                <input type="text" name="keyword" id="keyword" autocomplete="off" />
                <div id="keyword-suggestions"></div>
              </div>
              <div class="form-row region-container">
                <label>ì§€ì—­</label>
                <input type="text" name="region" id="region-input" autocomplete="off"/>
                <div id="region-suggestions"></div>
              </div>
              <div class="form-row search-container">
                <label>ìº í•‘ì¥</label>
                <input type="text" name="facltNm" id="search-keyword" autocomplete="off" />
                <div id="autocomplete-suggestions"></div>
              </div>
            </div>

            <button type="submit" class="search-btn"></button>
          </div>
        </form>
        <div class="popular-keywords" style="margin-top: 20px; border-top: 1px solid #84925a;">
          <h4 style="color: #fcfaf2; margin-bottom: 12px; font-size: 1rem; padding-left: 5px;">ğŸ”¥ ì¸ê¸° ê²€ìƒ‰ì–´</h4>
          <div class="tags" id="popular-keywords-container"></div>
        </div>
      </section>

      <div class="right-area">
        <!-- ë‚ ì”¨ -->
        <div class="weather-section">
          <div id="weather-widget-container"></div>
        </div>

        <div class="community box">
          <h3>
            ì»¤ë®¤ë‹ˆí‹°
            <a class="more" href="/posts/community">ë”ë³´ê¸°</a>
          </h3>
          <ul class="community-list">
            <li th:each="post : ${recentPosts}">
              <a class="post-title" th:href="@{/posts/community/{id}(id=${post.coId})}" th:text="${post.title}">ê¸€ ì œëª©</a>
              <span class="post-meta">
            <span class="post-writer" th:text="${post.writer}">ì‘ì„±ì</span> |
            <span class="post-date" th:text="${#temporals.format(post.createdAt, 'MM-dd')}">07-02</span> |
            <span class="post-views">ì¡°íšŒìˆ˜ <span th:text="${post.viewC}">0</span></span>
          </span>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- í•˜ë‹¨ ì¶”ì²œ ìº í•‘ì¥ -->

    <section class="recommend box">
      <h3>
        ì¶”ì²œ ìº í•‘ì¥
        <a th:href="@{/camping}" class="more">ë”ë³´ê¸°</a>
      </h3>
      <div class="recommend-scroll">
        <div class="recommend-camps" id="recommend-camps-container">
          <p>ì¶”ì²œ ìº í•‘ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
      </div>
    </section>

    <!-- ì¹´ì¹´ì˜¤ë§µ ì§€ë„ ì˜ì—­ -->
    <section class="map-section box">
      <h2>ìº í•‘ì¥ ì§€ë„</h2>
      <div class="map-container" style="position: relative;">
        <div id="main-map" style="width: 100%; height: 500px;"></div>
        <div id="roadview-container" style="width:100%; height:400px; display:none;"></div>
        <div class="map-controls"
          style="position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; gap: 8px;">
        </div>
      </div>
    </section>

  </div>

  <!-- Footer -->
  <div th:replace="~{fragments/footer :: site-footer}"></div>

  <!-- jQuery ë° jQuery UI -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

  <script src="/js/ranking.js"></script>
  <script src="/js/find-recommendation.js"></script>
  <script>
    // í˜ì´ì§€ ë¡œë”©ì´ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    document.addEventListener('DOMContentLoaded', () => {
      const main = document.querySelector('.main-container');
        if (main) {
          main.style.opacity = 1;
        }
      // ì¶”ì²œ ìº í•‘ì¥ ë°ì´í„°ë¥¼ ë¹„ë™ê¸°ë¡œ ìš”ì²­í•©ë‹ˆë‹¤.
      fetch('/camping/recommendations')
        .then(response => response.json())
        .then(camps => {
          const container = document.getElementById('recommend-camps-container');
          container.innerHTML = ''; // "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘" ë©”ì‹œì§€ ì œê±°

          if (camps && camps.length > 0) {
            camps.forEach(camp => {
              // ê° ìº í•‘ì¥ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ HTML ìš”ì†Œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
              const campLink = document.createElement('a');
              campLink.className = 'camp';
              campLink.href = `/camping/${camp.contentId}`;

              const defaultImageUrl = '/images/ì„ì‹œì‚¬ì§„.png';
              const imageUrl = camp.firstImageUrl ? camp.firstImageUrl : defaultImageUrl;

              campLink.innerHTML = `
              <img src="${imageUrl}" alt="ìº í•‘ì¥ ì´ë¯¸ì§€">
              <div class="camp-name">${camp.facltNm}</div>
              <p>${camp.lineIntro || ''}</p>
            `;
              container.appendChild(campLink);
            });
          } else {
            container.innerHTML = '<p>ì¶”ì²œ ìº í•‘ì¥ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          }
        })
        .catch(error => {
          console.error('ì¶”ì²œ ìº í•‘ì¥ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
          const container = document.getElementById('recommend-camps-container');
          container.innerHTML = '<p>ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
        });

      });

    /**
    * ìë™ì™„ì„± ê¸°ëŠ¥ì„ ì´ˆê¸°í™”í•˜ëŠ” 'ë§ŒëŠ¥ í•¨ìˆ˜'
    * ì´ í•¨ìˆ˜ í•˜ë‚˜ë¡œ ì—¬ëŸ¬ ê°œì˜ ìë™ì™„ì„± ê¸°ëŠ¥ì„ ë§Œë“¤ ìˆ˜ ìˆìŒ
    */

    // ìë™ ì™„ì„± ê¸°ëŠ¥ì„ ìœ„í•œ JS () - ìë™ ì™„ì„± ê¸°ëŠ¥ì„ ì´ˆê¸°í™” í•˜ëŠ” ë§ŒëŠ¥ í•¨ìˆ˜ ì œì‘
    function initializeAutocomplete(inputId, suggestionsId, apiUrl, formatter, valueField) {

      const inputElement = document.getElementById(inputId);
      const suggestionsContainer = document.getElementById(suggestionsId);

      if (!inputElement || !suggestionsContainer) {
        // í•„ìš”í•œ HTML ìš”ì†Œê°€ ì—†ì„ì‹œ í•¨ìˆ˜ë¥¼ ì¡°ìš©íˆ ì¢…ë£Œ í•¨
        return;
      }

      // ê²€ìƒ‰ ë¡œì§ì„ ë³„ë„ì˜ í•¨ìˆ˜ë¡œ ë¶„ë¦¬ (ì¬ì‚¬ìš©ì„ ìœ„í•¨)
      const performAutocompleteSearch = async () => {
        const keyword = inputElement.value;

        if (keyword.length == 0) {
          suggestionsContainer.innerHTML = '';
          suggestionsContainer.style.display = 'none'; // ì°½ ìˆ¨ê¸°ê¸°
          return;
        }

        try {
          const response = await fetch(`${apiUrl}?keyword=${encodeURIComponent(keyword)}`);
          if (!response.ok) {
            throw new Error(`ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${response.status}`);
          }

          const suggestions = await response.json();

          suggestionsContainer.innerHTML = '';

          if (suggestions.length == 0) {
            suggestionsContainer.style.display = 'none'; // ê²°ê³¼ì—†ìœ¼ë©´ ì°½ ìˆ¨ê¸°ê¸°
            return;
          }
          suggestionsContainer.style.display = 'block'; // ê²°ê³¼ìˆìœ¼ë©´ ë³´ì—¬ì£¼ê¸°

          suggestions.forEach(suggestion => {
            const item = document.createElement('div');
            // ì–´ë–¤ í•„ë“œë¥¼ ë³´ì—¬ì¤„ì§€ displayField íŒŒë¼ë¯¸í„°ë¡œ ê²°ì • í•¨
            item.className = 'suggestion-item';
            // 'í¬ë§¤í„° í•¨ìˆ˜(formatter)' ë¥¼ í˜¸ì¶œí•˜ì—¬ HTML ë‚´ìš©ì„ ë§Œë“¬
            item.innerHTML = formatter(suggestion);

            item.onclick = () => {
              // í´ë¦­ ì‹œ ê²€ìƒ‰ì°½ì— ìº í•‘ì¥ ì´ë¦„ì„ ë„£ê³  ê²€ìƒ‰ì„ ì‹¤í–‰ í˜¹ì€ ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™
              inputElement.value = suggestion[valueField];
              suggestionsContainer.style.display = 'none';
              //document.getElementsByClassName('search-btn').click() // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ íš¨ê³¼
            };

            suggestionsContainer.appendChild(item);

          });
        } catch (error) {
          console.error('ìë™ì™„ì„± ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
          suggestionsContainer.style.display = 'none';
        }
      };

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ ë“±ë¡

      // í‚¤ë¥¼ ì…ë ¥ì‹œ ë§ˆë‹¤ ê²€ìƒ‰ì„ ì§„í–‰
      inputElement.addEventListener('keyup', performAutocompleteSearch);

      // input ì°½ì„ ë‹¤ì‹œ í´ë¦­(í¬ì»¤ìŠ¤) í–ˆì„ë•Œ, ë‚´ìš©ì´ ìˆë‹¤ë©´ ê²€ìƒ‰ì„ ë‹¤ì‹œ ì‹¤í–‰
      inputElement.addEventListener('focus', performAutocompleteSearch);

      // ê²€ìƒ‰ì°½ì—ì„œ í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚˜ë©´ ê²°ê³¼ì°½ ìˆ¨ê¸°ê¸°
      inputElement.addEventListener('blur', function () {
        // ì•½ê°„ì˜ ë”œë ˆì´ë¥¼ ì¤˜ì„œ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ í•  ì‹œê°„ í™•ë³´
        setTimeout(() => {
          suggestionsContainer.innerHTML = '';
          suggestionsContainer.style.display = 'none';
        }, 200);
      });
    }

    /**
    * í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë”©ë  ë•Œ, ìœ„ì—ì„œ ë§Œë“  'ë§ŒëŠ¥ í•¨ìˆ˜'ë¥¼ í˜¸ì¶œí•´ì„œ
    * ê° ìë™ì™„ì„± ê¸°ëŠ¥ì„ ì‹¤ì œë¡œ ì ìš©í•¨.
    * ìƒˆë¡œìš´ ìë™ì™„ì„± ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ê³  ì‹¶ìœ¼ë©´,
    * ì•„ë˜ì— initializeAutocomplete(...) í˜¸ì¶œ ì½”ë“œ í•œ ì¤„ë§Œ ë” ì¶”ê°€í•˜ë©´ ë¨!
    */

    // í˜ì´ì§€ê°€ ë¡œë”© ë ì‹œ , ê° ì…ë ¥ì°½ì— ë§ê²Œ ë§ŒëŠ¥ í•¨ìˆ˜ë¥¼ í˜¸ì¶œ í•¨
    document.addEventListener('DOMContentLoaded', function () {
      // ìº í•‘ì¥ + ì§€ì—­ ìë™ì™„ì„± ê¸°ëŠ¥ì— ì ìš©
      initializeAutocomplete(
        'region-input',
        'region-suggestions',
        '/api/search/autocomplete/region',
        // ìº í•‘ì¥ + ì§€ì—­ì„ í˜ì´ì§€ì— ë³´ì—¬ì£¼ëŠ” íŠ¹ë³„í•œ ê°’ ì „ë‹¬
        (suggestion) => `<span class="suggestion-name">${suggestion.facltNm}</span><span class="suggestion-region">(${suggestion.doNm})</span>`,
        'facltNm'                              // í´ë¦­ì‹œì—ëŠ” ìº í•‘ì¥ì´ ì´ë¦„ë§Œ ì…ë ¥
      );

      // ìº í•‘ì¥ ìë™ì™„ì„± ê¸°ëŠ¥ì— ì ìš©
      initializeAutocomplete(
        'search-keyword',                       // ìº í•‘ì¥ ì…ë ¥ì°½ id
        'autocomplete-suggestions',             // ìº í•‘ì¥ ê²°ê³¼ì°½ id
        '/api/search/autocomplete/facltNm',     // ìº í•‘ì¥ api ì£¼ì†Œ
        // ìº í•‘ì¥ ì´ë¦„ í˜ì´ì§€ì— ë³´ì—¬ì£¼ëŠ” 'ê¸°ë³¸ ê°’' ì „ë‹¬
        (suggestion) => suggestion.facltNm,
        'facltNm'                               // ë³´ì—¬ì¤„ ë°ì´í„° í•„ë“œ
      );

      // í‚¤ì›Œë“œ ìë™ì™„ì„± ê¸°ëŠ¥ì— ì ìš©
      initializeAutocomplete(
        'keyword',                                // í‚¤ì›Œë“œ ì…ë ¥ì°½ id
        'keyword-suggestions',                    // í‚¤ì›Œë“œ ê²°ê³¼ì°½ id
        '/api/search/autocomplete/keyword',       // í‚¤ì›Œë“œ api ì£¼ì†Œ
        // í…Œë§ˆ ëª©ë¡ ê°„ë‹¨í•˜ê²Œ ë³´ì—¬ì£¼ëŠ” 'ê¸°ë³¸ ê°’' ì „ë‹¬
        (suggestion) => suggestion.keyword,
        'keyword'                                 // ë³´ì—¬ì¤„ ë°ì´í„° í•„ë“œ
      );

    });

  </script>

  <!-- ì¹´ì¹´ì˜¤ë§µ API: detail.htmlê³¼ ë³„ê°œë¡œ ë™ì‘í•˜ëŠ” ì§€ë„ -->
  <script
    src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ad22c50321e4a335c662c04e1bada00b&libraries=services"></script>
  <script src="/js/main-map.js"></script>

  <!-- ë‚ ì”¨ ìœ„ì ¯ -->
  <script src="/js/weather-widget.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.initMainMap) window.initMainMap();

      const el = document.getElementById('weather-widget-container');
      if (el && window.mountWeatherWidget) {
        mountWeatherWidget(el, 'ì„œìš¸');
      }
    });
  </script>

</body>

</html>